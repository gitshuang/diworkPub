"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},_react=require("react"),_react2=_interopRequireDefault(_react),_reactDnd=require("react-dnd"),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),_menus=require("../../bee/menus"),_menus2=_interopRequireDefault(_menus),_dropdown=require("../../bee/dropdown"),_dropdown2=_interopRequireDefault(_dropdown),_pop=require("../../pop"),_pop2=_interopRequireDefault(_pop),_button=require("../../bee/button"),_button2=_interopRequireDefault(_button),_button3=require("../../button"),_utils=require("../../utils"),_icon=require("../../icon"),_icon2=_interopRequireDefault(_icon),_checkbox=require("../../bee/checkbox"),_checkbox2=_interopRequireDefault(_checkbox),_message=require("../../bee/message"),_message2=_interopRequireDefault(_message),_manageWidgetList=require("../manageWidgetList"),_manageWidgetList2=_interopRequireDefault(_manageWidgetList);require("./style.css");var _style={widgetTitle:"widgetTitle__style___5B_lc",addBtn:"addBtn__style___1pYRJ",addGroupBtn:"addGroupBtn__style___3RkOC",titleInputArea:"titleInputArea__style___3_qnw",input:"input__style___1eXYC",newGroupName:"newGroupName__style___gKFWe",newGroupName_focus:"newGroupName_focus__style___2OcOs",newGroupName_blur:"newGroupName_blur__style___1QJJD",btn:"btn__style___1NAHM",icon:"icon__style___3S22Q",groupArea:"groupArea__style___3NyCg",selectedBackClass:"selectedBackClass__style___QJZ17",iconBox:"iconBox__style___CwgKm",widgetTitleInit:"widgetTitleInit__style___3JKUO",check_group:"check_group__style___2btKQ",noChildStyle:"noChildStyle__style___1sFC6"};function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defaults(e,t){for(var r=Object.getOwnPropertyNames(t),a=0;a<r.length;a++){var n=r[a],o=Object.getOwnPropertyDescriptor(t,n);o&&o.configurable&&void 0===e[n]&&Object.defineProperty(e,n,o)}return e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):_defaults(e,t))}function findItemById(e,t){for(var r=void 0,a=0;a<e.length&&(e[a].children&&(r=findItemById(e[a].children,t)),!r);a++)if(e[a].widgetId&&e[a].widgetId===t){r=e[a];break}return r}var type="item",itemSource={beginDrag:function(e,t){return{id:e.id,type:e.type,parentId:e.parentId,folderType:e.folderType}}},itemTarget={drop:function(e,t){var r=t.getItem().id,a=t.getItem().parentId,n=t.getItem().type,o=t.getItem().folderType,l=e.data.parentId;if(r!==e.id&&1===n&&1===e.data.type)e.moveGroupDrag(r,e.id);else if((2===n||3===n)&&1===e.data.type){e.data.parentId||(l=e.data.widgetId);var i=findItemById(e.data.children,r);("folder"===o||void 0===i||i&&i.widgetId!==r)&&e.moveItemDrag(r,a,n,e.id,l,e.data.type)}}};function collectSource(e,t){return{connectDragSource:e.dragSource(),isDragging:t.isDragging()}}function collectTaget(e,t){return{connectDropTarget:e.dropTarget(),isOver:t.isOver(),getItemType:t.getItem()}}Array.prototype.distinct=function(){var e,t=this,r={},a=[];t.length;for(e=0;e<t.length;e++)r[t[e]]||(r[t[e]]=1,a.push(t[e]));return a};var ManageGroup=(_temp=_class=function(t){function r(e){_classCallCheck(this,r);var c=_possibleConstructorReturn(this,t.call(this,e));return c.openRenameGroupFn=function(e){(0,c.props.setEditonlyId)(e),setTimeout(function(){c.refs.groupName.focus(),c.refs.groupName.select()},0),c.setState({inFoucs:!1})},c.renameGroupCancel=function(e){var t=c.props,r=t.renameGroup,a=t.setEditonlyId,n=c.props.data.widgetName,o=c.state.groupName;c.setState({groupName:n||o}),a(""),n||r({index:e,name:o}),c.setState({inFoucs:!1})},c.renameGroupFn=function(e){var t=c.props,r=t.renameGroup,a=t.manageList,n=t.languagesJSON,o=c.state.groupName;return o==a[e].widgetName?(c.renameGroupCancel(e),!1):a.map(function(e,t){return e.widgetName}).includes(o)?(_message2.default.create({content:n.group_name_exists,duration:1.5,position:"topLeft",color:"warning",style:{height:"auto"}}),!1):(r({index:e,name:o}),void c.renameGroupCancel(e))},c.clearInput=function(){c.setState({groupName:""})},c.editGroupName=function(e){var t=e.target.value;c.setState({groupName:t})},c.handleFocus=function(){c.setState({inFoucs:!0});var e=c.props,t=e.setDragInputState;e.dragState&&t(!1)},c.handleBlur=function(){c.setState({inFoucs:!1});var e=c.props,t=e.setDragInputState;e.dragState||t(!0)},c.selectFn=function(e,r){var t=c.props,a=t.selectListActions,n=t.manageList,o=t.selectList,l=t.selectGroup,i=t.selectGroupActions,s=e,u=n[r].children.map(function(e,t){return e.widgetId});s?(l.push(r),i(l),o=window.ActiveXObject||"ActiveXObject"in window?Array.from(o.concat(u).distinct()):Array.from(new Set(o.concat(u)))):(o=o.filter(function(e){return!u.includes(e)}),i(l.filter(function(e,t){return r!==e})));a(o)},c.popOpen=function(){c.setState({showModal:!0})},c.popClose=function(){c.setState({showModal:!1})},c.moveTopFn=function(e){(0,c.props.moveTopGroup)(e)},c.moveBottomFn=function(e){(0,c.props.moveBottomGroup)(e)},c.delectGroupFn=function(e){(0,c.props.delectGroup)(e)},c.onDropSelect=function(t){return function(e){switch(e.key){case"1":c.moveBottomFn(t);break;case"2":c.moveTopFn(t);break;default:c.delectGroupFn(t)}}},c.renderDrop=function(e){var t=c.props,r=t.manageList,a=t.languagesJSON,n=_react2.default.createElement(_menus2.default,{onClick:c.onDropSelect(e)},e!==r.length-1?_react2.default.createElement(_menus.Item,{key:"1"},a.move_down):null,e?_react2.default.createElement(_menus.Item,{key:"2"},a.move_up):null,_react2.default.createElement(_menus.Item,{key:"3"},a.delete));return _react2.default.createElement(_dropdown2.default,{trigger:["click"],overlay:n,animation:"slide-up"},_react2.default.createElement("div",null,_react2.default.createElement(_icon2.default,{title:a.more,type:"more"})))},c.state={groupName:"",inFoucs:!1,showModal:!1,selectGroup:[],selectList:[]},c}return _inherits(r,t),r.prototype.componentWillMount=function(){var a=this,e=this.props,t=e.data,r=t.widgetName,n=t.isNew,o=e.manageList,l=e.languagesJSON;n?setTimeout(function(){var e=o.map(function(e){return e.widgetName}),t=(0,_utils.avoidSameName)(e,l.group);a.setState({groupName:t}),a.refs.groupName.focus(),a.refs.groupName.select();var r=a.props;(0,r.checkFun)(r.currEditonlyId+"_btn")},0):this.setState({groupName:r})},r.prototype.componentWillReceiveProps=function(e){this.props.currEditonlyId!==e.currEditonlyId&&this.props.data.isNew&&(this.props.renameGroup({id:this.props.data.widgetId,name:""==this.state.groupName?this.props.data.widgetName:this.state.groupName,dontChangeCurrEditonlyId:!0}),this.setState({inFoucs:!1}))},r.prototype.addFolderFn=function(e){(0,this.props.addFolder)({groupIndex:e})},r.prototype.addGroupFn=function(e){(0,this.props.addGroup)({index:e})},r.prototype.render=function(){var t=this,e=this.props,r=e.manageList,a=e.curEditFolderId,n=e.drag,o=e.dragState,l=e.selectList,i=e.selectGroup,s=e.currEditonlyId,u=e.currGroupIndex,c=e.title,d=e.openFolder,p=e.deleteFolder,_=e.renameFolder,m=e.setFolderEdit,f=e.moveService,g=e.addFolder,y=e.closeFolder,h=e.setCurrGroupIndex,v=e.editTitle,b=e.selectListActions,w=e.selectGroupActions,N=e.cancelFolderEdit,I=e.setEditonlyId,S=e.setDragInputState,E=e.applicationsMap,G=e.allServicesByLabelGroup,F=e.getAllServicesByLabelGroup,D=e.setCurrentSelectWidgetMap,C=e.addDesk,T=e.requestSuccess,x=e.requestError,q=e.delectService,k=e.folderBgSrc,B=e.languagesJSON,O={manageList:r,curEditFolderId:a,drag:n,dragState:o,selectList:l,selectGroup:i,currEditonlyId:s,currGroupIndex:u,title:c,openFolder:d,deleteFolder:p,renameFolder:_,setFolderEdit:m,moveService:f,addFolder:g,closeFolder:y,setCurrGroupIndex:h,editTitle:v,selectListActions:b,selectGroupActions:w,cancelFolderEdit:N,setEditonlyId:I,setDragInputState:S,delectService:q,folderBgSrc:k},L={applicationsMap:E,manageList:r,allServicesByLabelGroup:G,getAllServicesByLabelGroup:F,setCurrentSelectWidgetMap:D,deleteFolder:p,addDesk:C,requestSuccess:T,requestError:x},R=this.props,A=R.data,M=A.widgetId,j=A.widgetName,W=A.children,J=R.index,P=R.connectDragSource,K=R.connectDropTarget,Q=R.isDragging,X=this.state,Y=X.inFoucs,z=X.groupName,H=X.showModal,U=-1<i.indexOf(J),Z=Q?0:1,V=void 0;V=s==M?_react2.default.createElement("div",{className:_style.widgetTitle},_react2.default.createElement("div",{className:_style.titleInputArea},_react2.default.createElement("input",{className:(Y?_style.newGroupName_focus:_style.newGroupName_blur)+" "+_style.newGroupName+" input",value:z,maxLength:"4",autoFocus:"autofocus",onChange:this.editGroupName,onFocus:this.handleFocus,onBlur:this.handleBlur,placeholder:B.groupName_max_words_four,ref:"groupName"})),_react2.default.createElement(_button3.ButtonCheckSelected,{id:M+"_btn",className:_style.btn,onClick:function(){t.renameGroupFn(J)}},_react2.default.createElement(_icon2.default,{type:"right"})),_react2.default.createElement(_button3.ButtonCheckClose,{className:_style.btn,onClick:function(){t.renameGroupCancel(J)}},_react2.default.createElement(_icon2.default,{type:"cancel"}))):_react2.default.createElement("div",{className:_style.widgetTitle+" "+_style.widgetTitleInit+" "},_react2.default.createElement("div",{className:_style.check_group},_react2.default.createElement(_checkbox2.default,{checked:U,onChange:function(e){t.selectFn(e,J)}},j),B.noDataGroup&&0===W.length?_react2.default.createElement("span",{className:_style.noChildStyle},_react2.default.createElement(_icon2.default,{type:"notice"}),B.noDataGroup):null),_react2.default.createElement("div",null,_react2.default.createElement("div",{className:_style.iconBox},_react2.default.createElement(_icon2.default,{title:B.rename_group,type:"record",onClick:function(){t.openRenameGroupFn(M)}})),_react2.default.createElement("div",{className:_style.iconBox},_react2.default.createElement(_icon2.default,{title:B.add_folder,type:"add-files",onClick:this.addFolderFn.bind(this,J)})),this.renderDrop(J)));var $=[{label:""+B.confirm,fun:this.delectGroupFn,className:""},{label:""+B.cancel,fun:this.popClose,className:""}],ee=this.props,te=ee.isOver,re=ee.getItemType,ae={};te&&1===re.type&&(ae={transform:"scale(1,1)",boxShadow:"0 0 0 3px #ddd,0 0 0 6px rgba(0,205,195,1)",borderRadius:"0"});var ne=_react2.default.createElement("div",{className:_style.groupArea+" animated zoomIn",style:_extends({},ae)},_react2.default.createElement("section",{style:_extends({},Z),className:Y?_style.selectedBackClass:""},V,_react2.default.createElement("div",null,_react2.default.createElement(_manageWidgetList2.default,_extends({index:J,data:W,parentId:this.props.data.widgetId},O,L,{languagesJSON:B})))),_react2.default.createElement("div",{className:_style.addBtn},_react2.default.createElement(_button3.ButtonDefaultWhite,{className:_style.addGroupBtn,onClick:this.addGroupFn.bind(this,J)},_react2.default.createElement(_icon2.default,{type:"add"}),B.addGroup)),_react2.default.createElement(_pop2.default,{className:"pop_dialog_delete",show:H,type:"delete",close:this.popClose,btns:$,data:{index:J}},_react2.default.createElement("div",{className:"pop_cont"},_react2.default.createElement("span",null,B.confirm_del_this_item))));return o?P(K(ne)):ne},r}(_react.Component),_class.propTypes={connectDragSource:_propTypes2.default.func.isRequired,connectDropTarget:_propTypes2.default.func.isRequired,index:_propTypes2.default.number.isRequired,isDragging:_propTypes2.default.bool.isRequired,id:_propTypes2.default.any.isRequired},_temp);exports.default=(0,_reactDnd.DragSource)(type,itemSource,collectSource)((0,_reactDnd.DropTarget)(type,itemTarget,collectTaget)(ManageGroup)),module.exports=exports.default;