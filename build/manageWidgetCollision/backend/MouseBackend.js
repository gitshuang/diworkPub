"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var MutationObserver=require("mutation-observer");function getEventClientOffset(e){return{x:e.clientX,y:e.clientY}}var ELEMENT_NODE=1;function getNodeClientOffset(e){var t=e.nodeType===ELEMENT_NODE?e:e.parentElement;if(!t)return null;var o=t.getBoundingClientRect(),n=o.top;return{x:o.left,y:n}}var MouseBackend=function(){function t(e){_classCallCheck(this,t),this.actions=e.getActions(),this.monitor=e.getMonitor(),this.registry=e.getRegistry(),this.sourceNodes={},this.sourceNodesOptions={},this.sourcePreviewNodes={},this.sourcePreviewNodesOptions={},this.targetNodes={},this.targetNodeOptions={},this.mouseClientOffset={},this.moveStartSourceIds=[],this.getSourceClientOffset=this.getSourceClientOffset.bind(this),this.handleWindowMoveStart=this.handleWindowMoveStart.bind(this),this.handleWindowMoveStartCapture=this.handleWindowMoveStartCapture.bind(this),this.handleWindowMove=this.handleWindowMove.bind(this),this.handleWindowMoveCapture=this.handleWindowMoveCapture.bind(this),this.handleWindowMoveEndCapture=this.handleWindowMoveEndCapture.bind(this)}return t.prototype.setup=function(){if("undefined"!=typeof window){if(this.constructor.isSetUp)throw new Error("Cannot have two DnD Mouse backend at the same time");this.constructor.isSetUp=!0,window.addEventListener("mousedown",this.handleWindowMoveStart),window.addEventListener("mousedown",this.handleWindowMoveStartCapture,!0),window.addEventListener("mousemove",this.handleWindowMove),window.addEventListener("mousemove",this.handleWindowMoveCapture,!0),window.addEventListener("mouseup",this.handleWindowMoveEndCapture,!0)}},t.prototype.getSourceClientOffset=function(e){return getNodeClientOffset(this.sourceNodes[e])},t.prototype.teardown=function(){"undefined"!=typeof window&&(this.constructor.isSetUp=!1,this.mouseClientOffset={},window.removeEventListener("mousedown",this.handleWindowMoveStart),window.removeEventListener("mousedown",this.handleWindowMoveStartCapture,!0),window.removeEventListener("mousemove",this.handleWindowMove),window.removeEventListener("mousemove",this.handleWindowMoveCapture,!0),window.removeEventListener("mouseup",this.handleWindowMoveEndCapture,!0))},t.prototype.connectDragSource=function(e,t){var o=this;this.sourceNodes[e]=t;var n=this.handleMoveStart.bind(this,e);return t.addEventListener("mousedown",n),function(){delete o.sourceNodes[e],t.removeEventListener("mousedown",n)}},t.prototype.connectDragPreview=function(e,t,o){var n=this;return this.sourcePreviewNodesOptions[e]=o,this.sourcePreviewNodes[e]=t,function(){delete n.sourcePreviewNodes[e],delete n.sourcePreviewNodesOptions[e]}},t.prototype.connectDropTarget=function(e,t){var o=this,n=this.handleMove.bind(this,e,t);return t.addEventListener("mousemove",n),function(){delete o.targetNodes[e],t.removeEventListener("mousemove",n)}},t.prototype.handleWindowMoveStartCapture=function(){this.moveStartSourceIds=[]},t.prototype.handleMoveStart=function(e){this.moveStartSourceIds.unshift(e)},t.prototype.handleWindowMoveStart=function(e){var t=getEventClientOffset(e);t&&(this.mouseClientOffset=t)},t.prototype.handleWindowMoveCapture=function(e){this.targetNodesObj={},this.targetNodes=[]},t.prototype.handleMove=function(e,t){this.targetNodesObj[e]=t,this.targetNodes.unshift(e)},t.prototype.handleWindowMove=function(e){var t=this.moveStartSourceIds,o=getEventClientOffset(e);if(o&&(this.monitor.isDragging()||!this.mouseClientOffset.hasOwnProperty("x")||!t||this.mouseClientOffset.x===o.x&&this.mouseClientOffset.y===o.y||(this.moveStartSourceIds=null,this.actions.beginDrag(t,{clientOffset:this.mouseClientOffset,getSourceClientOffset:this.getSourceClientOffset,publishSource:!1})),this.monitor.isDragging())){var n=this.sourceNodes[this.monitor.getSourceId()];this.installSourceNodeRemovalObserver(n),this.actions.publishDragSource(),e.preventDefault();var i=this.targetNodes,r=this.targetNodesObj;this.targetNodes=[],this.targetNodesObj={};var s=i.filter(function(e){var t=r[e].getBoundingClientRect();return o.x>=t.left&&o.x<=t.right&&o.y>=t.top&&o.y<=t.bottom});this.actions.hover(s,{clientOffset:o})}},t.prototype.handleWindowMoveEndCapture=function(e){this.monitor.isDragging()&&!this.monitor.didDrop()?(e.preventDefault(),this.mouseClientOffset={},this.uninstallSourceNodeRemovalObserver(),this.actions.drop(),this.actions.endDrag()):this.moveStartSourceIds=null},t.prototype.installSourceNodeRemovalObserver=function(e){var t=this;this.uninstallSourceNodeRemovalObserver(),this.draggedSourceNode=e,this.draggedSourceNodeRemovalObserver=new MutationObserver(function(){e.parentElement||(t.resurrectSourceNode(),t.uninstallSourceNodeRemovalObserver())}),e&&e.parentElement&&this.draggedSourceNodeRemovalObserver.observe(e.parentElement,{childList:!0})},t.prototype.resurrectSourceNode=function(){this.draggedSourceNode.style.display="none",this.draggedSourceNode.removeAttribute("data-reactid"),document.body.appendChild(this.draggedSourceNode)},t.prototype.uninstallSourceNodeRemovalObserver=function(){this.draggedSourceNodeRemovalObserver&&this.draggedSourceNodeRemovalObserver.disconnect(),this.draggedSourceNodeRemovalObserver=null,this.draggedSourceNode=null},t}();exports.default=MouseBackend,module.exports=exports.default;